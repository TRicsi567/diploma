version: "3.1"

services:
  keycloak-db:
    image: postgres:11.4
    environment:
      POSTGRES_DB: keycloak
      POSTGRES_USER: ${KEYCLOAK_DB_USER}
      POSTGRES_PASSWORD: ${KEYCLOAK_DB_PASSWORD}

  keycloak:
    image: lsybc/controltower-keycloak:snapshot
    environment:
      DB_VENDOR: postgres
      DB_ADDR: keycloak-db
      DB_DATABASE: keycloak
      DB_USER: ${KEYCLOAK_DB_USER}
      DB_PASSWORD: ${KEYCLOAK_DB_PASSWORD}
      KEYCLOAK_USER: ${KEYCLOAK_USER}
      KEYCLOAK_PASSWORD: ${KEYCLOAK_PASSWORD}
      PROXY_ADDRESS_FORWARDING: "true"
    command:
      [
        "-b",
        "0.0.0.0",
        "-Dkeycloak.migration.action=import",
        "-Dkeycloak.migration.provider=singleFile",
        "-Dkeycloak.migration.file=/opt/jboss/keycloak/import/realm-export.json",
        "-Dkeycloak.migration.strategy=OVERWRITE_EXISTING",
      ]
    depends_on:
      - keycloak-db
    restart: unless-stopped
    volumes:
      - ./e2e/keycloak-import/realm-export.json:/opt/jboss/keycloak/import/realm-export.json
    ports:
      - 9091:8080

  db:
    image: mysql:8.0
    restart: unless-stopped
    environment:
      MYSQL_DATABASE: ${MYSQL_DATABASE}
      MYSQL_USER: ${MYSQL_USER}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD}
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}

  backend:
    image: lsybc/controltower-backend:snapshot
    environment:
      - SPRING_PROFILES_ACTIVE=${SPRING_PROFILES_ACTIVE}
      - SPRING_DATASOURCE_URL=jdbc:mysql://db:3306/${MYSQL_DATABASE}?autoReconnect=true
      - SPRING_DATASOURCE_USERNAME=${MYSQL_USER}
      - SPRING_DATASOURCE_PASSWORD=${MYSQL_PASSWORD}
      - KEYCLOAK_REALM=${KEYCLOAK_REALM}
      - KEYCLOAK_REALM_KEY=${KEYCLOAK_REALM_KEY}
      - KEYCLOAK_AUTH_SERVER_URL=${KEYCLOAK_AUTH_SERVER_URL}
      - KEYCLOAK_RESOURCE=${KEYCLOAK_RESOURCE}
      - MEDIA_PUBLIC_URL=${MEDIA_PUBLIC_URL}
      - UPLOAD_IMAGE_DELETE_OLDER_THAN=P1D
      - UPLOAD_IMAGE_DELETE_INTERVAL=-
      - UPLOAD_TEMP_FOLDER_PATH=/tmp/controltower
      - MEDIA_FOLDER_PATH=/data/media
    restart: unless-stopped
    volumes:
      - ./images:/data/media:delegated

    depends_on:
      - db
    ports:
      - 9090:8080
